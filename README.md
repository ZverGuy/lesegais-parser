# lesegais/deal parser
Простой парсер который собирает информацию с https://www.lesegais.ru/open-area/deal и отправляет в SQL Server

# Алгоритм работы
При запуске программы после загрузки приложение запрашивает количество записей в mysql базы данных, чтобы убедиться база пустая или нет. 
Далее происходит запрос с GraphQL серверу, чтобы узнать количество записей всего.
Это необходимо для пропуска проверки уникальности по ключу, тк в этом случае проверка не нужна.

Далее происходит запуск бесконечного цикла со следующими этапами
- Парсинг
- Валидация
- Взаимодействие с базой данной (запись и проверка по ключу)


# Парсинг
Парсинг данных реализован путем прямых обращений к GraphQL и последующей сериализацией и валидацией.

Размер данных за 1 запрос - 1000 записей

Обоснование: при запросе 1000 записей время до ответа не слишком долгое. Также количество записей в минуту не увеличивается при большом количестве записей (т.е слабое место - бд, либо слой взаимодействия с бд)
# Валидация
После сериализации в промежуточную модель в классе SearchWoodModelValidator происходит валидация.

Покрытые кейсы валидации:
1. Имя продавца не пустое
2. Имя покупателя не пустое
3. ИНН продавца не пустой и содержит цифры (при включенной строгой валидации)
4. ИНН Покупателя не пустой и содержит цифры (при включенной строгой валидации)
5. Дата сделки находится в промежутки между 1900 годом и текущей датой.

Обоснования:
1. Потому что не может быть в реальности что название компании продавца было пустым
2. Тоже самое что и 1 пункт
3. Потому что ИНН в РФ является числовым и не может быть пустым или состоящим из букв
4. Тоже самое
5. Потому что не может быть записей за 2116 год и за 901 год

После успешного прохождения валидации идет запись новый записи или обновление старой.

# Работа с Базой Данных

Слой работы с базой данный сделан на основе ADO.NET

При попытки добавления новой записи он проверяет существует такая же запись уже в базе (проверка происходит по ключу). 

Если запись найдена и параметр UpdateRecords равен true, то происходит проверка являются ли записи полностью одинаковыми. Если не одинаковые - происходит обновление.

# Конфигурация 
```json
{
  "ConnectionString" : "Server=localhost;Database=db;User Id=sa;Password=lmao;\n",
  "RequestDelay": 3,
  "MaxRetries": 3,
  "RecordCountPerRequest": 999,
  "DealCount" : 300000,
  "EnableStrictValidation": false,
  "UpdateRecords": true
}
```
`ConnectionString` - строка подключения к базе данных. Обязательный параметр.

`RequestDelay` - задержка после запроса в секундах. По умолчанию равен `3`

`MaxRetries` - количество попыток спарсить страницу, если не получилось с 1 раза. Если попытки кончились - страница пропускается. По умолчанию `3`

`RecordCountPerRequest` - сколько парсится записей с 1 запроса. По умолчанию `999`

`EnableStrictValidation` - Включение строгой валидации моделей (дополнительная проверка ИНН и названий компаний). По умолчанию `false`

`UpdateRecords` - Обновлять ли записи, если найдено совпадение по ключу. По умолчанию `true`




